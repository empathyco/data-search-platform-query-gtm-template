___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Empathy Platform - Search query",
  "categories": ["ANALYTICS", "PERSONALIZATION"],
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/jpeg;base64,/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABkAAD/4QMxaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjYtYzE0MCA3OS4xNjA0NTEsIDIwMTcvMDUvMDYtMDE6MDg6MjEgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDQyAyMDE4IChNYWNpbnRvc2gpIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOkY1QkI4MjdENjQzRDExRTlCMDI4RTA0MjBFNzNGMTU1IiB4bXBNTTpEb2N1bWVudElEPSJ4bXAuZGlkOkY1QkI4MjdFNjQzRDExRTlCMDI4RTA0MjBFNzNGMTU1Ij4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6RjVCQjgyN0I2NDNEMTFFOUIwMjhFMDQyMEU3M0YxNTUiIHN0UmVmOmRvY3VtZW50SUQ9InhtcC5kaWQ6RjVCQjgyN0M2NDNEMTFFOUIwMjhFMDQyMEU3M0YxNTUiLz4gPC9yZGY6RGVzY3JpcHRpb24+IDwvcmRmOlJERj4gPC94OnhtcG1ldGE+IDw/eHBhY2tldCBlbmQ9InIiPz7/7gAOQWRvYmUAZMAAAAAB/9sAhAABAQEBAQEBAQEBAQEB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\u003d\u003d"
  },
  "description": "Fire this tag when a search is performed in your site populating variables collecting search data.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "instanceID",
    "displayName": "Instance ID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "valueHint": "i.e. mycompany name",
    "help": "Introduce the Instance ID assigned to your project. If you don\u0027t know it, contact with Support Team"
  },
  {
    "type": "TEXT",
    "name": "query",
    "displayName": "Query",
    "simpleValueType": true,
    "valueHint": "i.e. jeans, table, lipstick ...",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "help": "Query string used in the search"
  },
  {
    "type": "TEXT",
    "name": "totalHits",
    "displayName": "Number of results",
    "simpleValueType": true,
    "valueHint": "i.e. 124, 58, 0 ...",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "NON_NEGATIVE_NUMBER"
      }
    ],
    "help": "Number of results returned by the search query"
  },
  {
    "type": "TEXT",
    "name": "page",
    "displayName": "Results page number",
    "simpleValueType": true,
    "help": "Results page number",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "POSITIVE_NUMBER"
      }
    ],
    "valueHint": "i.e 1, 2, ..."
  },
  {
    "type": "TEXT",
    "name": "sessionId",
    "displayName": "Session ID",
    "simpleValueType": true,
    "help": "Short term session identifier (recommended expiration 30\u0027)",
    "valueHint": "i.e. 45gdfasd7543jdafs"
  },
  {
    "type": "CHECKBOX",
    "name": "spellcheck",
    "checkboxText": "Spellcheck",
    "simpleValueType": true,
    "help": "Checks whether the query has come via spellcheck or not"
  },
  {
    "type": "GROUP",
    "name": "origin",
    "displayName": "Origin",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "SELECT",
        "name": "feature",
        "displayName": "Feature",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "search_box",
            "displayValue": "search_box"
          },
          {
            "value": "url",
            "displayValue": "url"
          },
          {
            "value": "query_suggestion",
            "displayValue": "query_suggestion"
          },
          {
            "value": "next_query",
            "displayValue": "next_query"
          },
          {
            "value": "popular_search",
            "displayValue": "popular_search"
          },
          {
            "value": "history_query",
            "displayValue": "history_query"
          },
          {
            "value": "partial_result",
            "displayValue": "partial_result"
          },
          {
            "value": "related_tag",
            "displayValue": "related_tag"
          },
          {
            "value": "spellcheck",
            "displayValue": "spellcheck"
          },
          {
            "value": "customer",
            "displayValue": "customer"
          },
          {
            "value": "semantics",
            "displayValue": "semantics"
          }
        ],
        "simpleValueType": true,
        "help": "Which feature is the origin of the action. Recommended values:\nsearch_box\nurl\nquery_suggestion\nnext_query\npopular_search\nhistory_query\npartial_result\nrelated_tag\nspellcheck\ncustomer\nsemantics",
        "notSetText": "",
        "defaultValue": ""
      },
      {
        "type": "SELECT",
        "name": "location",
        "displayName": "Location",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "external",
            "displayValue": "external"
          },
          {
            "value": "my_history",
            "displayValue": "my_history"
          },
          {
            "value": "no_query",
            "displayValue": "no_query"
          },
          {
            "value": "results",
            "displayValue": "results"
          },
          {
            "value": "no_results",
            "displayValue": "no_results"
          },
          {
            "value": "low_results",
            "displayValue": "low_results"
          },
          {
            "value": "none",
            "displayValue": "none"
          },
          {
            "value": "predictive_layer",
            "displayValue": "predictive_layer"
          },
          {
            "value": "pdp",
            "displayValue": "pdp"
          },
          {
            "value": "url_history",
            "displayValue": "url_history"
          },
          {
            "value": "url_history_pdp",
            "displayValue": "url_history_pdp"
          }
        ],
        "simpleValueType": true,
        "help": "Where the feature is located. Recommended values:\nexternal\nmy_history\nno_query\nresults\nno_results\nlow_results\nnone\npredictive_layer\npdp\nurl_history\nurl_history_pdp",
        "notSetText": "",
        "defaultValue": ""
      }
    ],
    "help": "Origin of the query. Composed by two fields. \n- Feature: Which feature is the origin of the action\n- Location: Where the feature is located"
  },
  {
    "type": "GROUP",
    "name": "facets",
    "displayName": "Facets",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "CHECKBOX",
        "name": "filtered",
        "checkboxText": "Facet applied",
        "simpleValueType": true,
        "help": "Checks whether the query/view has been filtered or not"
      },
      {
        "type": "PARAM_TABLE",
        "name": "filters",
        "displayName": "Facets",
        "paramTableColumns": [
          {
            "param": {
              "type": "TEXT",
              "name": "facetName",
              "displayName": "Facet name",
              "simpleValueType": true,
              "help": "Include the facet name"
            },
            "isUnique": false
          },
          {
            "param": {
              "type": "TEXT",
              "name": "facetValue",
              "displayName": "Facet value",
              "simpleValueType": true,
              "help": "Include the facet value"
            },
            "isUnique": false
          }
        ],
        "help": "Facets that the user has set for the query. For each facet applied you should include one row in the table with the name and the value. The same facet_name can be specified several times to provide multiple values selection.",
        "enablingConditions": [
          {
            "paramName": "filtered",
            "paramValue": true,
            "type": "EQUALS"
          }
        ]
      }
    ],
    "help": "Facets that the user has set for the query in the format facet_name:facet_value|facet_name:facet_value|facet_name:facet_value. The same facet_name can be specified several times to provide multiple values selection."
  },
  {
    "type": "GROUP",
    "name": "globalFilters",
    "displayName": "Filter parameters",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "lang",
        "displayName": "Language",
        "simpleValueType": true,
        "help": "The product catalog language",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "valueHint": "i.e. es, en, fr..."
      },
      {
        "type": "TEXT",
        "name": "scope",
        "displayName": "Scope",
        "simpleValueType": true,
        "help": "Can be used to track the device that shoppers use to interact with the store",
        "valueValidators": [],
        "valueHint": "i.e. desktop, tablet, mobile..."
      },
      {
        "type": "TEXT",
        "name": "catalog",
        "displayName": "Catalog",
        "simpleValueType": true,
        "help": "Can be used to track interaction with specific categories of the product catalogue.",
        "valueValidators": [],
        "valueHint": "i.e. food, non-food, homeware..."
      },
      {
        "type": "TEXT",
        "name": "store",
        "displayName": "Store",
        "simpleValueType": true,
        "help": "Can be used to track shopper interaction with specific stores in a global site",
        "valueValidators": [],
        "valueHint": "i.e. ES, US, UK..."
      },
      {
        "type": "TEXT",
        "name": "section",
        "displayName": "Section",
        "simpleValueType": true,
        "help": "Can be used to track interaction with specific sections of the store",
        "valueValidators": [],
        "valueHint": "i.e. women, men, kids..."
      },
      {
        "type": "PARAM_TABLE",
        "name": "customFilters",
        "displayName": "Custom filters",
        "paramTableColumns": [
          {
            "param": {
              "type": "TEXT",
              "name": "customFilterName",
              "displayName": "Filter name",
              "simpleValueType": true
            },
            "isUnique": true
          },
          {
            "param": {
              "type": "TEXT",
              "name": "customFilterValue",
              "displayName": "Filter Value",
              "simpleValueType": true
            },
            "isUnique": false
          }
        ],
        "newRowButtonText": "Add custom filter",
        "help": "To include custom filters you need to configure them on the Instance Manage Console or contact Support Team",
        "newRowTitle": "Add new custom filter"
      }
    ],
    "help": "Filter parameters according to the valid filter names and values set on the tagging configuration. \n\nhttps://docs.empathy.co/explore-empathy-platform/configure-empathy-platform/configure-tagging.html#configuring-filter-settings"
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Enter your template code here.
const log = require('logToConsole');
log('data =', data);

const sendPixel = require('sendPixel');
const encodeUri = require('encodeUri');
const encodeUriComponent = require('encodeUriComponent');
const query = require('queryPermission');

//Base request URL
let base_url = "https://api.empathy.co/tagging/v1/track/";

//Get parameters:
let parameters = [];
var i = 0;

//1.Query (q)
if(typeof(data.query) !== "undefined" && data.query !== ""){
	parameters[i] = 'q=' + encodeUriComponent(data.query);
	i++;
}
//2.Number of results (totalHits):
if(typeof(data.totalHits) !== "undefined" && data.totalHits !== ""){
	parameters[i] = 'totalHits=' + encodeUriComponent(data.totalHits);
  	i++;
}
//3.SERP Number of results (page):
if(typeof(data.page) !== "undefined" && data.page !== ""){
	parameters[i] = 'page=' + encodeUriComponent(data.page);
	i++;
}
//4.Session Id (session)
if(typeof(data.sessionId) !== "undefined" && data.sessionId !== ""){
	parameters[i] = 'session=' + encodeUriComponent(data.sessionId);
	i++;
}
//5.Spellcheck enabled (spellcheck)
if(data.spellcheck){
	parameters[i] = 'spellcheck=true';
	i++;
}else{
    parameters[i] = 'spellcheck=false';
	i++;
}
//6.Origin of the query. It is composed by feature and location fields (origin)
if(typeof(data.feature) !== "undefined" && data.feature !== ""){
  if(typeof(data.location) !== "undefined" && data.location !== ""){
    parameters[i] = 'origin=' + encodeUriComponent(data.feature + ":" + data.location);
    i++;
  }else{
	parameters[i] = 'origin=' + encodeUriComponent(data.feature);
	i++;
  }
}
//7.List of facets applied to the query (filtered & filters)
if(data.filtered){
  parameters[i] = 'filtered=false';
  i++;
  if(typeof(data.filters) !== "undefined" && data.filters.length > 0){
    let facet = "";
    for (var j=0; j < data.filters.length ; j++){
  	  if(typeof(data.filters[j]) !== "undefined" && data.filters[j] !== ""){
      	facet = facet + data.filters[j].facetName + ':' + data.filters[j].facetValue + "|";
      }
    }
    parameters[i] = 'filters=' + encodeUriComponent(facet.substring(0, facet.length-1));
    i++;
  }
}else{
    parameters[i] = 'filtered=false';
	i++;
}
//7.List of globlar filters (lang, scope...)
//7.1.Languge of the catalog (lang)
if(typeof(data.lang) !== "undefined" && data.lang !== ""){
	parameters[i] = 'lang=' + encodeUriComponent(data.lang);
	i++;
}
//7.2.Device (scope)
if(typeof(data.scope) !== "undefined" && data.scope !== ""){
	parameters[i] = 'scope=' + encodeUriComponent(data.scope);
	i++;
}
//7.3.Catalog used (catalog)
if(typeof(data.catalog) !== "undefined" && data.catalog !== ""){
	parameters[i] = 'catalog=' + encodeUriComponent(data.catalog);
	i++;
}
//7.4.Store selected (store)
if(typeof(data.store) !== "undefined" && data.store !== ""){
	parameters[i] = 'store=' + encodeUriComponent(data.store);
	i++;
}
//7.5.Section selected (section)
if(typeof(data.section) !== "undefined" && data.section !== ""){
	parameters[i] = 'section=' + encodeUriComponent(data.section);
	i++;
}
//7.6.Custom filters 
if(typeof(data.customFilters) !== "undefined" && data.customFilters.length > 0){
    for (var j=0; j < data.customFilters.length ; j++){
  	  if(typeof(data.customFilters[j]) !== "undefined" && data.customFilters[j] !== ""){
      	parameters[i] = encodeUriComponent(data.customFilters[j].customFilterName) +'=' + encodeUriComponent(data.customFilters[j].customFilterValue);
        i++;
      }
    }
  }

//Send request:
//Request built
let request_url = base_url + data.instanceID + "/query";
let url = encodeUri(request_url);
let path_input = '?' + parameters.join('&');
let url_send = url + path_input;

log('request =', url_send);

//Set request permissions:
if (query('send_pixel', base_url)) {
  sendPixel(url_send,data.gtmOnSuccess, data.gtmOnFailure);
}


// Call data.gtmOnSuccess when the tag is finished.
data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_pixel",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://api.empathy.co/tagging/v1/track/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 24/9/2024, 12:50:24


